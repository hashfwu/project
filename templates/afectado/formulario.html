{% extends "layout/layout_1.html" %}

{% block title %}Afectado{% endblock %}

{% block hero %}

    <section class="bg-dark text-white py-5">
      <div class="container py-4">
        <div class="text-center">
          <h2 class="display-5 fw-bold mb-4">Reporte sus perdidas en cualquier momento</h2>
          <p class="lead mb-5">Nuestro sistema le permite realizar reportes de perdidas según el área al que pertenece</p>
        </div>
      </div>
    </section>
{% endblock %}

{% block content %}
<h3 class="mb-4 text-center">Registrarse</h3>

<div id="mensaje-ci" class="alert alert-success d-none" role="alert"></div>

<form action="{{ url_for('afectado.register') }}" method="post" class="needs-validation" novalidate>
    <div class="mb-3">
        <label for="registerCi" class="form-label">CI</label>
        <input type="text" class="form-control" id="registerCi" name="ci" required>
    </div>

    <div class="mb-3">
        <label for="registerExpedido" class="form-label">Expedido</label>
        <select class="form-select" id="registerExpedido" name="expedido" required>
            <option value="" disabled selected>Seleccione...</option>
            <option value="LP">LP</option>
            <option value="SCZ">SCZ</option>
            <option value="CBBA">CBBA</option>
            <option value="OR">OR</option>
            <option value="PT">PT</option>
            <option value="CH">CH</option>
            <option value="TJA">TJA</option>
            <option value="BE">BE</option>
            <option value="PD">PD</option>
            <option value="EX">EX</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="registerPaterno" class="form-label">Apellido Paterno</label>
        <input type="text" class="form-control" id="registerPaterno" name="paterno" required>
    </div>

    <div class="mb-3">
        <label for="registerMaterno" class="form-label">Apellido Materno</label>
        <input type="text" class="form-control" id="registerMaterno" name="materno" required>
    </div>

    <div class="mb-3">
        <label for="registerNombre" class="form-label">Nombre</label>
        <input type="text" class="form-control" id="registerNombre" name="nombre" required>
    </div>

    <div class="mb-3">
        <label for="registerSexo" class="form-label">Sexo</label>
        <select class="form-select" id="registerSexo" name="sexo" required>
            <option value="" disabled selected>Seleccione...</option>
            <option value="masculino">Masculino</option>
            <option value="femenino">Femenino</option>
            <option value="otro">Otro</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="registerNacimiento" class="form-label">Nacimiento</label>
        <input type="date" class="form-control" id="registerNacimiento" name="nacimiento" required>
    </div>

    <div class="mb-3">
        <label for="registerIdArea" class="form-label">ID Area</label>
        <input type="number" class="form-control" id="registerIdArea" name="id_area" required>
    </div>

    <div class="mb-3">
        <label for="registerTelefono" class="form-label">Teléfono</label>
        <input type="tel" class="form-control" id="registerTelefono" name="telefono" required>
    </div>

    <div class="mb-3">
        <label for="registerEmail" class="form-label">Correo Electrónico</label>
        <input type="email" class="form-control" id="registerEmail" name="email" required>
    </div>

    <div class="mb-3">
        <label for="registerUbicacion" class="form-label">Ubicación del domicilio</label>
        <input type="text" class="form-control" id="registerUbicacion" name="ubicacion" required>
    </div>

    <div class="mb-3">
        <label for="registerCondicion" class="form-label">Condición del afectado</label>
        <input type="text" class="form-control" id="registerCondicion" name="condicion" required>
    </div>

    <div class="d-grid">
        <button type="submit" class="btn btn-success">Registrar</button>
    </div>
    <div class="d-grid mt-2">
        <button type="button" class="btn btn-secondary" onclick="limpiarFormulario(this.form)">Limpiar</button>
    </div>
</form>

    <script>
    document.getElementById('registerCi').addEventListener('blur', function () {
        const ci = this.value;

        if (ci) {
            fetch(`{{ url_for('afectado.buscar_ci') }}?ci=${ci}`)
                .then(response => {
                    if (!response.ok) {
                        limpiarYRestaurarCampos();
                        throw new Error('No encontrado');
                    }
                    return response.json();
                })
                .then(data => {

                    const mensajeCi = document.getElementById('mensaje-ci');
                    mensajeCi.textContent = 'Se encontraron datos que coinciden con su carnet. Puede editarlos luedo de iniciar sesion.';
                    mensajeCi.classList.remove('d-none');
                    mensajeCi.classList.add('alert-success');

                    const fieldsToLock = [
                        'registerExpedido',
                        'registerPaterno',
                        'registerMaterno',
                        'registerNombre',
                        'registerSexo',
                        'registerNacimiento'
                    ];

                    document.getElementById('registerExpedido').value = data.expedido || '';
                    document.getElementById('registerPaterno').value = data.paterno || '';
                    document.getElementById('registerMaterno').value = data.materno || '';
                    document.getElementById('registerNombre').value = data.nombre || '';
                    document.getElementById('registerSexo').value = data.sexo || '';
                    document.getElementById('registerNacimiento').value = data.nacimiento || '';

                    fieldsToLock.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            if (field.tagName === 'SELECT') {
                                const hidden = document.createElement('input');
                                hidden.type = 'hidden';
                                hidden.name = field.name;
                                hidden.value = field.value;
                                field.form.appendChild(hidden);
                                field.disabled = true;
                            } else {
                                field.readOnly = true;
                            }
                            field.style.cursor = 'not-allowed';
                        }
                    });
                })
                .catch(error => {
                    console.log('No se encontró el CI o error en la búsqueda:', error.message);
                    limpiarYRestaurarCampos();
                });
        } else {
            limpiarYRestaurarCampos();
        }
    });

    function limpiarYRestaurarCampos() {

        const mensajeCi = document.getElementById('mensaje-ci');
        mensajeCi.classList.add('d-none');
        mensajeCi.textContent = '';

        const fieldsToLock = [
            'registerExpedido',
            'registerPaterno',
            'registerMaterno',
            'registerNombre',
            'registerSexo',
            'registerNacimiento'
        ];

        fieldsToLock.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = '';
                if (field.tagName === 'SELECT') {
                    field.disabled = false;
                } else {
                    field.readOnly = false;
                }
                field.style.cursor = '';
            }
        });
    }
    </script>
{% endblock %}